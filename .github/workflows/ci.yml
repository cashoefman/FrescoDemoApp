name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build and Test
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3

    - name: Clone Fresco Package
      working-directory: ..
      run: |
        git clone https://github.com/disruptiveio/Fresco.git

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '16.2'

    - name: Build Project
      run: |
        xcodebuild -scheme FrescoDemoApp -destination 'platform=iOS Simulator,name=Any iOS Simulator Device' clean build CODE_SIGNING_ALLOWED=NO

    - name: Check for Available iOS Simulators
      id: check_sim
      run: |
        AVAILABLE=$(xcrun simctl list devices | grep -v unavailable | grep -E "iPhone|iPad" | grep -c Shutdown || true)
        echo "Found $AVAILABLE available simulators"
        if [[ "$AVAILABLE" -eq 0 ]]; then
          echo "skip=true" >> $GITHUB_OUTPUT
        else
          echo "skip=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Unit Tests
      if: steps.check_sim.outputs.skip != 'true'
      run: |
        xcodebuild test \
          -scheme FrescoDemoApp \
          -destination 'platform=iOS Simulator,name=Any iOS Simulator Device' \
          CODE_SIGNING_ALLOWED=NO

    - name: Run SwiftLint
      run: |
        brew install swiftlint
        swiftlint || true